const mongoose = require('mongoose');

const cafeSchema = new mongoose.Schema({
    cafe_id: { type: String, required: true, unique: true }, // AutoGenerated, in the format cafe_[string]
    name: { type: String, required: true },
    location: { type: String, required: true },
    image_url: { type: String },
    audio_url: { type: String },
    average_bill: { type: Number, default: 0 },
    discount: { type: Number, default: 0 },
    ratings: { type: Number, min: 0, max: 5, default: 0 },
    specials: { type: String },
    cafe_owner_id: { type: String, ref: 'User', default: null },
    createdAt: { type: Date, default: Date.now },
    updatedAt: { type: Date, default: Date.now },
});

// Pre-save hook to auto-generate cafe_id
cafeSchema.pre('save', async function (next) {
    if (this.isNew) {
        let count = 1;
        let cafe_id = `cafe_${String(count).padStart(3, '0')}`; // e.g., cafe_001

        // Check for existing cafe_id and increment until unique
        while (await mongoose.models.Cafe.findOne({ cafe_id })) {
            count++;
            cafe_id = `cafe_${String(count).padStart(3, '0')}`;
        }

        this.cafe_id = cafe_id;
    }
    next();
});

module.exports = mongoose.model('Cafe', cafeSchema);